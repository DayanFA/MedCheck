<div class="aluno-checkin-wrapper">
  <div class="card p-4 unified-card">
    <div class="row g-4">
      <div class="col-12 col-xl-4">
        <!-- Seção de status movida para Home -->
        <!-- Barra de botões removida (Iniciar/Atualizar) conforme solicitação -->
  <div class="mt-2 small" [class.text-success]="message.includes('realizado')" [class.text-danger]="message.startsWith('Falha')">{{message}}</div>
        <h6 class="mb-3 d-flex align-items-center gap-3">Registrar Check-In
          <button type="button" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2 camera-btn" (click)="toggleScan()">
            <i class="bi" [ngClass]="scanning ? 'bi-camera-video-off' : 'bi-camera'" style="font-size:1.4rem; color:#0d6efd;"></i>
            <span class="fw-semibold text-primary">{{ scanning ? 'Parar' : 'Ler QR' }}</span>
          </button>
        </h6>
        <div *ngIf="scanning" class="mb-3">
          <div class="row g-2 align-items-end mb-2">
            <div class="col-sm-6">
              <label class="form-label small mb-1">Câmera</label>
              <select class="form-select form-select-sm" [(ngModel)]="selectedDeviceId" (change)="onChangeDevice()">
                <option *ngFor="let d of videoDevices" [value]="d.deviceId">{{ d.label || 'Câmera' }}</option>
              </select>
            </div>
            <div class="col-sm-6 text-sm-end small text-muted" *ngIf="!videoDevices.length">Listando câmeras...</div>
          </div>
          <div class="qr-video-wrapper mb-2">
            <video #qrVideo class="qr-video rounded border" playsinline muted autoplay></video>
          </div>
          <div class="small text-muted">Aponte para o QR do preceptor para preencher automaticamente.</div>
        </div>
        <div class="row g-2 align-items-end">
          <!-- Select de disciplina removido para o aluno: disciplina vem da preferência/global -->
          <div class="col-6">
            <label class="form-label small">ID Preceptor</label>
            <input type="number" class="form-control form-control-sm" [(ngModel)]="preceptorId" />
          </div>
          <div class="col-6">
            <label class="form-label small">Código</label>
            <input type="text" class="form-control form-control-sm" [(ngModel)]="code" />
          </div>
          <div class="col-12 d-grid">
            <button class="btn btn-primary btn-sm" (click)="submitCheckIn()" [disabled]="submitting || status?.inService">Check-In</button>
          </div>
          <div class="col-12 d-grid mt-2" *ngIf="status?.inService">
            <button class="btn btn-warning btn-sm" (click)="openCheckoutConfirm()" [disabled]="submitting">Realizar Check-Out</button>
          </div>
          <div *ngIf="showCheckoutConfirm" class="checkout-modal-backdrop">
            <div class="checkout-modal card p-3 p-sm-4">
              <h6 class="fw-semibold mb-3">Confirmar Check-Out</h6>
              <p class="small mb-2">Você realmente deseja encerrar seu turno agora?</p>
              <p class="small mb-3">Horas de hoje até o momento: <strong>{{ workedToday }}</strong></p>
              <div class="d-flex flex-wrap gap-2 justify-content-end">
                <button class="btn btn-outline-secondary btn-sm" (click)="cancelCheckout()" [disabled]="submitting">Cancelar</button>
                <button class="btn btn-warning btn-sm" (click)="confirmCheckout()" [disabled]="submitting">Confirmar</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Texto antigo removido conforme solicitação -->
      </div>
      <div class="col-12 col-xl-8">
        <div class="d-flex flex-wrap justify-content-between align-items-end mb-3 gap-2">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <h6 class="mb-0">Histórico</h6>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" (click)="loadHistory('today')">Hoje</button>
              <button class="btn btn-outline-secondary" (click)="loadHistory('3d')">3 dias</button>
              <button class="btn btn-outline-secondary" (click)="loadHistory('3w')">3 semanas</button>
              <button class="btn btn-outline-secondary" (click)="loadHistory('all')">Tudo</button>
            </div>
          </div>
          <form class="d-flex align-items-end gap-2 flex-wrap" (submit)="$event.preventDefault(); applyDateFilter();">
            <div>
              <label class="form-label small mb-1">Início</label>
              <input type="date" class="form-control form-control-sm" [(ngModel)]="startDate" name="startDate" />
            </div>
            <div>
              <label class="form-label small mb-1">Fim</label>
              <input type="date" class="form-control form-control-sm" [(ngModel)]="endDate" name="endDate" />
            </div>
            <div class="pb-1">
              <button class="btn btn-primary btn-sm" type="submit">Filtrar</button>
            </div>
          </form>
        </div>
        <div class="small text-muted mb-2" *ngIf="filterMessage">{{filterMessage}}</div>
        <div *ngIf="loadingHistory" class="small text-muted">Carregando...</div>
        <div *ngIf="!loadingHistory && !history.length" class="small text-muted">Sem registros.</div>
        <div class="table-responsive">
          <table *ngIf="!loadingHistory && history.length" class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Entrada</th>
                <th class="text-center">Loc (In)</th>
                <th>Saída</th>
                <th class="text-center">Loc (Out)</th>
                <th>Duração</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let h of pagedHistory">
                <td>{{h.checkInTime | date:'dd/MM HH:mm'}}</td>
                <td class="text-center" style="width:120px;">
                  <ng-container *ngIf="h.checkInLat!=null && h.checkInLng!=null; else noInLoc">
                    <small class="d-block text-muted">{{h.checkInLat | number:'1.4-4'}}, {{h.checkInLng | number:'1.4-4'}}</small>
                    <button class="btn btn-link p-0" title="Ver local de entrada" (click)="openLocation(h.checkInLat,h.checkInLng)">
                      <i class="bi bi-geo-alt-fill text-primary"></i>
                    </button>
                  </ng-container>
                  <ng-template #noInLoc><span class="badge bg-secondary">sem loc</span></ng-template>
                </td>
                <td>{{h.checkOutTime ? (h.checkOutTime | date:'dd/MM HH:mm') : '-'}} </td>
                <td class="text-center" style="width:120px;">
                  <ng-container *ngIf="h.checkOutLat!=null && h.checkOutLng!=null; else noOutLoc">
                    <small class="d-block text-muted">{{h.checkOutLat | number:'1.4-4'}}, {{h.checkOutLng | number:'1.4-4'}}</small>
                    <button class="btn btn-link p-0" title="Ver local de saída" (click)="openLocation(h.checkOutLat,h.checkOutLng)">
                      <i class="bi bi-geo-alt text-success"></i>
                    </button>
                  </ng-container>
                  <ng-template #noOutLoc><span class="badge bg-secondary">sem loc</span></ng-template>
                </td>
                <td>{{h.worked || '-'}} </td>
              </tr>
            </tbody>
          </table>
          <ng-container *ngIf="showLocModal">
            <app-location-modal [lat]="locLat!" [lng]="locLng!" [onClose]="closeLocation"></app-location-modal>
          </ng-container>
          <nav *ngIf="!loadingHistory && totalPages > 1" class="mt-2">
            <ul class="pagination pagination-sm mb-0 flex-wrap">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="prevPage()" [disabled]="currentPage===1">«</button>
              </li>
              <li class="page-item" *ngFor="let p of pages" [class.active]="p===currentPage">
                <button class="page-link" (click)="setPage(p)">{{p}}</button>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <button class="page-link" (click)="nextPage()" [disabled]="currentPage===totalPages">»</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
