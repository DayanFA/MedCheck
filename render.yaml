services:
  # MySQL as a private service inside Render
  - name: mysql
    type: private_service
    env: docker
    plan: starter
    rootDir: infra
    dockerfilePath: ./mysql.Dockerfile
    envVars:
      - key: MYSQL_ROOT_PASSWORD
        value: changeMeRoot
      - key: MYSQL_DATABASE
        value: medcheck
      - key: MYSQL_USER
        value: meduser
      - key: MYSQL_PASSWORD
        value: changeMeUser
    disk:
      name: mysql-data
      mountPath: /var/lib/mysql
      sizeGB: 10

  # Spring Boot API
  - name: medcheck-api
    type: web
    rootDir: medcheckapi
    plan: starter
    autoDeploy: true
    buildCommand: ./mvnw -DskipTests package
    startCommand: >-
      java -Dserver.port=$PORT
           -Dspring.datasource.url=jdbc:mysql://mysql:3306/medcheck?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=America/Rio_Branco
           -Dspring.datasource.username=meduser
           -Dspring.datasource.password=changeMeUser
           -Dspring.sql.init.mode=never
           -Dapp.jwt-secret=$APP_JWT_SECRET
           -Dapp.reset.base-url=$APP_RESET_BASE_URL
           -jar target/*.jar
    envVars:
      - key: APP_JWT_SECRET
        generateValue: true
      - key: APP_RESET_BASE_URL
        fromService:
          name: medcheck-web
          type: web
          property: url
      - key: FRONTEND_ORIGINS
        fromService:
          name: medcheck-web
          type: web
          property: url

  # Angular SSR Web (serving the app and proxying /api to the backend)
  - name: medcheck-web
    type: web
    rootDir: medcheckapp
    plan: starter
    autoDeploy: true
    buildCommand: npm ci && npm run build
    startCommand: node dist/medcheckapp/server/server.mjs
    envVars:
      - key: API_URL
        fromService:
          name: medcheck-api
          type: web
          property: url